<!DOCTYPE html>
<html>

<head lang="en">
    <title>RAID SERVER</title>
    <meta charset="utf-8" />
    <script src="https://sdpi-components.dev/releases/v4/sdpi-components.js"></script>
    <style>
        .path-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .path-row sdpi-textfield {
            flex: 1;
        }
        .auto-detect-btn {
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .auto-detect-btn:hover {
            background: #106ebe;
        }
        .auto-detect-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status-message {
            padding: 8px;
            margin-top: 8px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
        .status-message.error {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
            display: block;
        }
        .status-message.success {
            background: rgba(0, 255, 0, 0.2);
            color: #69db7c;
            display: block;
        }
    </style>
</head>

<body>
    <sdpi-item label="EFT Path">
        <div class="path-row">
            <sdpi-textfield id="eft_path_input" setting="eft_install_path" placeholder="Enter the path to your EFT folder"></sdpi-textfield>
            <button class="auto-detect-btn" id="autoDetectBtn" onclick="autoDetectPath()">Auto Detect</button>
        </div>
    </sdpi-item>
    
    <div id="statusMessage" class="status-message"></div>

    <sdpi-item label="Auto Update">
        <sdpi-checkbox setting="raid_autoupdate_check"></sdpi-checkbox>
    </sdpi-item>


    <div style="
    border: solid gray 1px;
    border-radius: 8px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: center;
    gap: 4px;
    color: white;
    font-size: 13px;
    background: rgba(0,0,0,.5);
    font-family: system-ui;
">
        <div>
            <b style="color: lime;">Auto Detect</b> - Automatically finds your EFT installation from the Windows Registry.
        </div>
        <div>
            <b style="color: lime;">Auto Update</b> - Automatically updates the current server. You won't need to press the button in every raid.
        </div>
    </div>
    
    <script>
        // Use SDPIComponents.streamDeckClient with v4 API
        const streamDeckClient = SDPIComponents.streamDeckClient;
        
        // Listen for messages from plugin using v4 subscribe pattern
        streamDeckClient.sendToPropertyInspector.subscribe(function(ev) {
            console.log('PI: Received from plugin:', ev);
            handlePluginMessage(ev.payload);
        });
        
        // Request global settings on load
        streamDeckClient.send('sendToPlugin', { command: 'getGlobalSettings' });
        
        function handlePluginMessage(data) {
            const statusEl = document.getElementById('statusMessage');
            const btn = document.getElementById('autoDetectBtn');
            
            console.log('PI: handlePluginMessage:', data);
            
            if (data.event === 'autoDetectResult') {
                btn.disabled = false;
                btn.textContent = 'Auto Detect';
                
                if (data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = 'Found: ' + data.path;
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = data.error || 'EFT installation not found';
                }
                
                // Hide message after 5 seconds
                setTimeout(function() {
                    statusEl.className = 'status-message';
                }, 5000);
            } else if (data.event === 'globalSettings') {
                // Pre-fill with global settings if no action-specific setting
                if (data.eft_install_path) {
                    const pathInput = document.querySelector('sdpi-textfield[setting="eft_install_path"]');
                    if (pathInput && !pathInput.value) {
                        pathInput.value = data.eft_install_path;
                    }
                }
            }
        }
        
        function autoDetectPath() {
            const btn = document.getElementById('autoDetectBtn');
            const statusEl = document.getElementById('statusMessage');
            
            btn.disabled = true;
            btn.textContent = 'Detecting...';
            statusEl.className = 'status-message';
            
            console.log('PI: Sending autoDetectPath command');
            streamDeckClient.send('sendToPlugin', { command: 'autoDetectPath' });
        }
    </script>

</body>

</html>