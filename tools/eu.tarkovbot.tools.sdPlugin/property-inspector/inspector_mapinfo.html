<!DOCTYPE html>
<html>

<head lang="en">
  <title>MAP INFO</title>
  <meta charset="utf-8" />
  <script src="https://sdpi-components.dev/releases/v4/sdpi-components.js"></script>
</head>

<body>
  <sdpi-item label="EFT Path">
    <div style="display: flex; flex-direction: column; width: 100%; gap: 8px;">
      <sdpi-textfield id="eft_path_input" setting="eft_install_path" placeholder="Enter path to EFT folder"></sdpi-textfield>
      <button style="background: #0078d4; color: white; border: none; border-radius: 4px; padding: 7px; cursor: pointer; font-size: 12px; font-weight: bold;" id="autoDetectBtn" onclick="autoDetectPath()">
        Auto Detect
      </button>
    </div>
  </sdpi-item>

  <div id="statusMessage" class="status-message" style="display: none; margin: 10px; padding: 8px; border-radius: 4px; font-size: 12px; font-family: system-ui;"></div>

  <sdpi-item label="Auto Update">
    <sdpi-checkbox setting="map_autoupdate_check"></sdpi-checkbox>
  </sdpi-item>

  <sdpi-item label="PVE Mode">
    <sdpi-checkbox setting="pve_map_mode_check"></sdpi-checkbox>
  </sdpi-item>

  <div style="padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; border-left: 3px solid lime; font-family: system-ui;">

    <div style="margin-bottom: 10px;">
      <b style="color: white; font-size: 12px;">Auto Detect:</b>
      <div style="color: #ccc; font-size: 11px; line-height: 1.4;">Automatically finds your EFT installation from the Windows Registry.</div>
    </div>

    <div style="margin-bottom: 10px;">
      <b style="color: white; font-size: 12px;">Auto Update:</b>
      <div style="color: #ccc; font-size: 11px; line-height: 1.4;">Automatically updates the current map. You won't need to press the button after every raid. Just press it once and leave the profile open.</div>
    </div>

    <div>
      <b style="color: white; font-size: 12px;">PVE Mode:</b>
      <div style="color: #ccc; font-size: 11px; line-height: 1.4;">The displayed map data will be based on PVE values.</div>
    </div>
  </div>

  <hr style="border: 0; border-top: 1px solid #333; margin: 20px 10px 10px 10px;">

  <div style="padding: 0 10px 10px 10px; font-family: system-ui; display: flex; flex-direction: column; align-items: center;">
    <p style="margin: 0 0 8px 0; font-size: 10px; font-weight: 700; text-transform: uppercase; color: #888; letter-spacing: 1px;">Support the Project</p>
    <button style="width: 100%; background: #FF424D; color: white; border: none; border-radius: 4px; padding: 8px; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.2s;" onmouseover="this.style.background='#e33b44'" onmouseout="this.style.background='#FF424D'" onclick="SDPIComponents.streamDeckClient.send('sendToPlugin', 'openPatreon');">
      Visit our Patreon
    </button>
  </div>

  <script>
    const streamDeckClient = SDPIComponents.streamDeckClient;
    streamDeckClient.sendToPropertyInspector.subscribe((ev) => handlePluginMessage(ev.payload));
    streamDeckClient.send('sendToPlugin', {
      command: 'getGlobalSettings'
    });

    function handlePluginMessage(data) {
      const statusEl = document.getElementById('statusMessage');
      const btn = document.getElementById('autoDetectBtn');

      if (data.event === 'autoDetectResult') {
        btn.disabled = false;
        btn.textContent = 'Auto Detect';
        statusEl.style.display = 'block';
        if (data.success) {
          statusEl.style.background = 'rgba(0, 255, 0, 0.1)';
          statusEl.style.color = '#69db7c';
          statusEl.textContent = 'Found: ' + data.path;
        } else {
          statusEl.style.background = 'rgba(255, 0, 0, 0.1)';
          statusEl.style.color = '#ff6b6b';
          statusEl.textContent = data.error || 'EFT not found';
        }
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 5000);
      } else if (data.event === 'globalSettings') {
        if (data.eft_install_path) {
          const pathInput = document.querySelector('sdpi-textfield[setting="eft_install_path"]');
          if (pathInput && !pathInput.value) pathInput.value = data.eft_install_path;
        }
      }
    }

    function autoDetectPath() {
      const btn = document.getElementById('autoDetectBtn');
      btn.disabled = true;
      btn.textContent = 'Detecting...';
      streamDeckClient.send('sendToPlugin', {
        command: 'autoDetectPath'
      });
    }
  </script>
</body>

</html>